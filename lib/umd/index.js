/**
 * Bundle of ytdl2transcript
 * Generated: 2019-12-13
 * Version: 1.0.0
 * License: MIT
 * Author: Laurian Gridinoc <laurian@gridinoc.name> (https://gridinoc.com)
 */

!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";function l(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],r=!0,i=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(r=(o=u.next()).done)&&(e.push(o.value),!n||e.length!==n);r=!0);}catch(t){i=!0,a=t}finally{try{r||null==u.return||u.return()}finally{if(i)throw a}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(t){return function(t){if(Array.isArray(t)){for(var n=0,e=new Array(t.length);n<t.length;n++)e[n]=t[n];return e}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function d(){for(var t=null;!(t=n.generate()).match(/^[a-z]([0-9]|[a-z])+([0-9a-z]+)[a-z]$/i););return t}function p(t){return t.reverse().reduce(function(t,i){return!i.end&&0<t.length&&(i.end=t[0].start),i.words&&0!==i.words.length||(i.words=i.text.split(" ").reduce(function(t,n,e,r){return[].concat(f(t),[{id:d(),start:i.start+Math.floor(e*(i.end-i.start)/r.length),end:i.start+Math.floor((e+1)*(i.end-i.start)/r.length),offset:0===e?0:t.map(function(t){return t.text}).join(" ").length+1,length:n.length,text:n}])},[])),[i].concat(f(t))},[])}var t,g=require("fs"),y=require("xml2js"),u=require("vtt.js"),n=require("shortid"),e=require("../input/subs.info.json").subtitles,r=require("../input/auto-subs.info.json").automatic_captions,i=function(n,e){var r,i,a,o;return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:global.navigator={userAgent:""},r=[],(i=new u.WebVTT.Parser({VTTCue:u.VTTCue,VTTRegion:u.VTTRegion},u.WebVTT.StringDecoder())).oncue=function(t){return r.push(t)},i.parse(g.readFileSync("./input/".concat(n),{encoding:"utf-8"})),i.flush(),g.writeFileSync("./debug/".concat(n,".parsed.json"),JSON.stringify(r,null,2),"utf8"),a=p(r.map(function(t){var n=t.startTime,e=t.text,r=1e3*parseFloat(n);return{id:d(),start:r,text:e.trim()}})),g.writeFileSync("./debug/".concat(n,".paragraphs.json"),JSON.stringify(a,null,2),"utf8"),o={id:d(),lang:e,paragraphs:a},g.writeFileSync("./output/".concat(n,".json"),JSON.stringify(o,null,2),"utf8");case 11:case"end":return t.stop()}})},a=function(n,e){var r,i,a,o,u,c,s;return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(y.parseStringPromise(g.readFileSync("./input/".concat(n),{encoding:"utf-8"}),{attrkey:"attrs",charkey:"text",trim:!0,explicitArray:!0}));case 2:u=t.sent,g.writeFileSync("./debug/".concat(n,".parsed.json"),JSON.stringify(u,null,2),"utf8"),c=p((null!==(r=null==u?void 0:null===(i=u.tt)||void 0===i?void 0:null===(a=i.body[0])||void 0===a?void 0:null===(o=a.div[0])||void 0===o?void 0:o.p)&&void 0!==r?r:[]).map(function(t){var n=t.attrs.begin,e=t.text,r=l(n.split(":"),3),i=1e3*(3600*r[0]+60*r[1]+r[2]);return{id:d(),start:i,text:e}})),g.writeFileSync("./debug/".concat(n,".paragraphs.json"),JSON.stringify(c,null,2),"utf8"),s={id:d(),lang:e,paragraphs:c},g.writeFileSync("./output/".concat(n,".json"),JSON.stringify(s,null,2),"utf8");case 8:case"end":return t.stop()}})},o=function(n,e){var r,i,a,o,u,c;return regeneratorRuntime.async(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,regeneratorRuntime.awrap(y.parseStringPromise(g.readFileSync("./input/".concat(n),{encoding:"utf-8"}),{attrkey:"attrs",charkey:"text",trim:!0,explicitArray:!0}));case 2:o=t.sent,g.writeFileSync("./debug/".concat(n,".parsed.json"),JSON.stringify(o,null,2),"utf8"),u=p((null!==(r=null==o?void 0:null===(i=o.timedtext)||void 0===i?void 0:null===(a=i.body[0])||void 0===a?void 0:a.p)&&void 0!==r?r:[]).filter(function(t){var n=t.s,e=t.text;return!!n||!!e}).map(function(t){var n=t.attrs.t,e=t.s,r=void 0===e?[]:e,i=t.text,s=parseInt(n,10),a=r.reduce(function(t,n,e){var r=n.attrs,i=r.t,a=void 0===i?0:i,o=r.ac,u=void 0===o?0:o,c=n.text;return[].concat(f(t),[{id:d(),start:s+parseInt(a,10),end:s+parseInt(a,10)+parseInt(u,10),offset:0===e?0:t.map(function(t){return t.text}).join(" ").length+1,length:c.length,text:c}])},[]);return{id:d(),start:s,end:0<a.length?a[a.length-1].end:null,text:null!=i?i:a.map(function(t){return t.text}).join(" "),words:a}})),g.writeFileSync("./debug/".concat(n,".paragraphs.json"),JSON.stringify(u,null,2),"utf8"),c={id:d(),lang:e,paragraphs:u},g.writeFileSync("./output/".concat(n,".json"),JSON.stringify(c,null,2),"utf8");case 8:case"end":return t.stop()}})};t=[["subs",e],["auto-subs",r]].reduce(function(t,n){var e=l(n,2),a=e[0],r=e[1];return[].concat(f(t),f(Object.entries(r).reduce(function(t,n){var e=l(n,2),r=e[0],i=e[1];return[].concat(f(t),f(i.map(function(t){var n=t.ext;return{lang:r,ext:n,type:a,file:"".concat(a,".").concat(r,".").concat(n)}})))},[])))},[]).filter(function(t){var n=t.file;return g.existsSync("./input/".concat(n))}),console.log(JSON.stringify(t,null,2)),t.forEach(function(t){var n=t.lang,e=(t.type,t.ext),r=t.file;switch(e){case"srv3":o(r,n);break;case"ttml":a(r,n);break;case"vtt":i(r,n);break;default:console.warn("Unknown format ".concat(e))}})});
